name: Build and Deploy docs

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - '*.*.*'
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or SHA) to build"
        required: false
        default: "main"
      version:
        description: "Docs version label (for example: 0.1.0 or latest)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: "docs-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && (inputs.version == 'latest' && 'main' || inputs.ref) || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Resolve deployment version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION="latest"
          fi
          echo "value=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          if [[ -f "docs/requirements.txt" ]]; then
            pip install -r docs/requirements.txt
          fi
          # Ensure mike-compatible tooling exists for legacy tags.
          pip install "mkdocs<2" mkdocs-material "mike>=2.1" "pymdown-extensions>=10.7"

      - name: Prepare mike-compatible mkdocs config
        if: steps.version.outputs.value != 'latest'
        run: |
          python - <<'PY'
          from pathlib import Path
          import yaml

          config_path = Path("mkdocs.yml")

          if config_path.exists():
            config = yaml.safe_load(config_path.read_text()) or {}
          else:
            config = {
              "site_name": "DeepMatch",
              "site_description": "Android deeplink toolkit",
              "site_url": "https://aouledissa.com/deep-match/",
              "repo_url": "https://github.com/aouledissa/deep-match",
              "repo_name": "aouledissa/DeepMatch",
              "docs_dir": "docs",
            }

          config.setdefault("docs_dir", "docs")

          theme = config.get("theme")
          if theme is None:
            theme = {"name": "material"}
          elif isinstance(theme, str):
            theme = {"name": theme}
          elif isinstance(theme, dict):
            theme.setdefault("name", "material")
          else:
            theme = {"name": "material"}
          config["theme"] = theme

          plugins = config.get("plugins")
          if plugins is None:
            plugins = []
          elif isinstance(plugins, str):
            plugins = [plugins]

          def has_plugin(name: str) -> bool:
            for item in plugins:
              if isinstance(item, str) and item == name:
                return True
              if isinstance(item, dict) and name in item:
                return True
            return False

          if not has_plugin("search"):
            plugins.insert(0, "search")
          if not has_plugin("mike"):
            plugins.append({"mike": {"alias_type": "copy"}})
          config["plugins"] = plugins

          extra = config.get("extra")
          if not isinstance(extra, dict):
            extra = {}
          version = extra.get("version")
          if not isinstance(version, dict):
            version = {}
          version["provider"] = "mike"
          extra["version"] = version
          config["extra"] = extra

          if "nav" not in config and Path("docs").exists():
            nav = []
            if Path("docs/index.md").exists():
              nav.append({"Overview": "index.md"})
            if Path("docs/plugin.md").exists():
              nav.append({"Plugin": "plugin.md"})
            if Path("docs/gradle_plugin.md").exists():
              nav.append({"Gradle Plugin": "gradle_plugin.md"})
            if Path("docs/deeplink-specs.md").exists():
              nav.append({"Deeplink Specs": "deeplink-specs.md"})
            if Path("docs/config_file.md").exists():
              nav.append({"YAML Spec": "config_file.md"})
            if nav:
              config["nav"] = nav

          Path("mkdocs.versioned.yml").write_text(
            yaml.safe_dump(config, sort_keys=False)
          )
          PY

      - name: Configure Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy latest documentation (zensical)
        if: steps.version.outputs.value == 'latest'
        run: |
          zensical build
          python .github/scripts/inject_version_selector.py
          git fetch origin gh-pages:gh-pages || true
          WORKTREE_DIR="$(mktemp -d)"
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git worktree add "${WORKTREE_DIR}" gh-pages
          else
            git worktree add --detach "${WORKTREE_DIR}"
            (
              cd "${WORKTREE_DIR}"
              git checkout --orphan gh-pages
              git rm -rf . >/dev/null 2>&1 || true
            )
          fi
          mkdir -p "${WORKTREE_DIR}/latest"
          rsync -a --delete site/ "${WORKTREE_DIR}/latest/"
          cat > "${WORKTREE_DIR}/index.html" <<'EOF'
          <!doctype html>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./latest/">
          <link rel="canonical" href="./latest/">
          <title>DeepMatch Docs</title>
          <p>Redirecting to <a href="./latest/">latest documentation</a>...</p>
          EOF
          touch "${WORKTREE_DIR}/.nojekyll"
          (
            cd "${WORKTREE_DIR}"
            git add -A
            if git diff --cached --quiet; then
              echo "No changes to publish for latest."
              exit 0
            fi
            git commit -m "docs: publish latest (zensical) from ${GITHUB_SHA}"
            git push origin HEAD:gh-pages
          )
          git worktree remove "${WORKTREE_DIR}" --force

      - name: Deploy versioned documentation
        if: steps.version.outputs.value != 'latest'
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          mike deploy -F mkdocs.versioned.yml --push --update-aliases "${VERSION}"
